{% extends "account/base.html" %}

{% load i18n %}
{% load form_utils %}

{% block head_title %}{% trans "Welcome" %}{% endblock %}

{% block content %}
<h1>{% trans "<span>Welcome</span>" %}</h1>

<p>{% blocktrans %}Please tell us a bit more about yourself, so we can provide you with a personal experience. All your information will be kept private and secure.{% endblocktrans %}</p>


<form class="signup step-form" method="post">
  {% csrf_token %}

  <div class="steps">
      Step {{form_step}}/{{form_total_steps}}
  </div>
  <div class="inside">

  {% for field in form %} 
    <p{{ field.row_attrs }}>
        
        {% if field|is_checkbox %}
            <span class="field-checkbox">
                {{ field }}
                {{ field.label_tag }}
            </span>
        {% elif field.name == 'location' %}
            {{ field.label_tag }}
            {{ field }}
            
            <span style="margin-bottom:1em">
                <!--<a href="javascript:getLocation()" class="button secondaryAction" disabled>{% trans "Search for location" %}</a>-->
                <a href="javascript:getLocation()" class="button secondaryAction" id="getLocationButton">{% trans "Automatically get location" %}</a>
            </span>

            <span id="location_options"></span>

            or type to search
            
            <input type="text" name="location_search" placeholder="Type address to search..." value="{{object.location.display_name}}">
            
        {% else %}
            {{ field.label_tag }}
            {{ field }}
        {% endif %}

        {% if field.help_text %}<span class="help">{{ field.help_text }}</span>{% endif %}
    </p>
    {{ field.errors }}
  {% endfor %}

  <button type="submit">{% trans "Continue" %} &raquo;</button>

  </div>
  
</form>

<script>
    function getLocation() {
        if ("geolocation" in navigator) {
          document.getElementById('location_options').innerHTML = 'Loading...';
            navigator.geolocation.getCurrentPosition(function(position) {
                fetch('/api/areas/?lat='+position.coords.latitude+'&lon='+position.coords.longitude).then(resp => resp.json()).then(
                    data => {
                        console.log(data);
                        var html = data.results.map(area => 
                          '<li><a href="javascript:selectLocation(' + area.pk + ',\'' + area.display_name + '\')">' + area.display_name + '</a></li>'
                        ).join('');
                        var msg = 'Please select your location';
                        document.getElementById('location_options').innerHTML = msg + '<ul>' + html + '</ul>';
                    }
                );
            });
        }
    }
    function selectLocation(key, label) {
      document.forms[0].location_search.value = label;
      document.forms[0].location.value = key;
      document.getElementById('location_options').innerHTML = '';
    }
</script>

{% endblock %}